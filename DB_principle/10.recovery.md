第十章、数据库恢复技术

## 事务的基本概念

### 定义
- 一个数据库操作序列
- 一个不可分割的工作单位
- 恢复和并发控制的基本单位

### 定义事务

```sql
BEGIN TRANSACTION
    SQL 语句1 
    SQL 语句2 
    ...
COMMIT(ROLLBACK)
```

- COMMIT
    - 事务正常结束
    - 提交事务的所有操作
    - 事务中所有操作永久生效
- ROLLBACK
    - 事务异常终止
    - 回滚事务的所有更新操作
    - 事务滚回到开始时的状态

### 事务的特性(ACID)

ACID
- 原子性(Atomicity)
    > 事务是诗句哭的逻辑工作单位
- 一致性(Consistency)
    > 事务中的操作要么全做，要么全不做
- 隔离性(Isolation)
    > 各个事务的执行互不干扰
- 持续性(Durability)
    > 一个事务一旦提交，对数据的改变是永久性的


破坏ACID特性的因素
- 并发控制：多个事务并行运行时，不同事务的操作交叉执行
- 恢复技术：事务在运行过程中被强行停止

## 数据库恢复概述

数据库的恢复：把数据库从错误状态恢复到某一已知的正确状态
> 数据库恢复的基础：备份

## 故障的种类

种类
- 事务内部的故障
    > 事务故障的恢复：撤销事务(UNDO)
- 系统故障
    > - 发送故障时，事务为提交：强行撤销(UNDO)所有未完成事务  
    > - 发送故障时，事务已提交，但未写入磁盘：重做(REDO)所有已提交的事务 
- 介质故障
    > 转入备份数据库，重做(REDO)所有成功事务
- 计算机病毒



## 恢复的实现技术

### 数据转储
转储方法

#### 静态转储与动态转储

- 静态转储
    - 无运行事务时的转储操作
    - 转储期间不允许对数据库的任何操作

- 动态转储
    - 转储操作和用户事务并行
    - 转储期间允许对数据库进行操作
        > 不能保证副本中的数据是最新的,可能在转储期间被修改  
        > 需要把转储期间各事务对数据库的修改记录下来,建立日志文件


#### 海量转储与增量转储

- 海量转储：每次转储全部数据库

- 增量转储：只转储上次转储后更新过的数据


### 登录日志文件

日志文件是用来记录事务对数据库的**更新操作**的文件  
> 先写日志文件，后进行数据库操作

1. 日志文件的格式
- 以记录为单位的日志文件
    > 每条日志记录的内容：各个事务代码，各个事务的所有更新操作
- 以数据块为单位的日志文件
    > 每条日志记录的内容：事务标记，数据更新前后的值

## 恢复策略

### 事务故障的恢复

描述：事务在运行至正常终点前被终止

恢复方法：有恢复子系统利用日志文件撤销(UNDO)此事务已对数据库进行的修改

> 系统自动完成

### 系统故障的恢复

恢复方法：
- Undo故障发生时未完成的事务
- Redo已完成的事务
> 重启时自动完成

### 介质故障的恢复 

恢复方法：
- 重装数据库 
- 重做已完成的事务


## 具有检查点的恢复技术 

### 问题的提出

系统故障利用体制进行恢复的两个问题
- 搜索整个日志将耗费大量的时间
- REOD处理：重新执行，浪费了大量时间

解决方案
具备检查点的恢复技术
- 在日志文件中增加检查点记录(checkpoint)
- 增加重新开始文件
- 恢复子系统在登陆日志文件期间动态的维护日志

### 检查点技术

检查点记录的内容
- 建立检查点时刻所有正在执行的事务清单
- 这些事务最近一个日志记录的地址

重新开始文件的内容
- 记录各个检查点记录在日志中的地址

动态维护日志文件的方法
- 周期性的执行日下操作：建立检查点，保存数据库状态


### 利用检查点的恢复策略

1. 从开始文件中找到最后一个检查点记录在日志文件中的地址，由该地址找到最后一个检查点记录  
2. 由检查点建立时所有正在执行的事务清单ACTIVE-LIST 
    1. 建立两个事务队列:UNDO-LIST和REDO-LIST
    2. 把ACTIVE-LIST暂时放入UNDO-LIST中，REDO为空
3. 由开始点开始扫描文件
    1. 如果有新开始的事务t,把t暂时放入UNDO-LIST队列中
    2. 如果有提交的事务t,把t从UNDO-LIST队列移动到REDO-LIST队列中
4. 对UNDO-LIST队列中的每个事务执行UNDO操作，REDO-LIST执行REDO操作


## 数据库镜像

DBMS自动把整个数据库或其中的关键数据复制到另一个磁盘上  
DBMS自动保存镜像数据与主数据库的一致性
> 每当主数据库更新时，DBMS自动把更新后的数据复制过去
