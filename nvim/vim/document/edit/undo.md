<!-- [neovim][nvim]vim/undo.md -->
撤销与重做


# 撤销和重做操作的命令

```lua
u               -- 撤销[count]次更改 
:u[ndo]         -- 撤销一次更改
:u[ndo] {N}     --转到改变号{N}之后

U               -- 撤销对最近所修改行所做的一系列更改
                -- 当对其他行进行修改，或删除当前行，将失去对该行的记录，此时无法用U恢复
                -- U自己也可作为更改被撤销
```


```lua
<CTRL-R>        -- 重做 [count] 次被撤销的更改
:red[o]         -- 重做一个被撤销的更改
```



# 撤销分支

撤销树

```lua
:undol[ist]     -- 列出改变树的所有叶结点
```
- "number" 列是改变号。这个编号持续增加，用于标识特定可撤销的改变
- "changes" 列是树的根结点到此叶结点所需的改变数目
-  "when" 列是此改变发生的日期时间
-  "save" 列给出此改变是否已写入硬盘和第几次写入文件


```lua
g-/+            -- 转到较早/新的文本状态
                -- 如果带计数，重复那么多次
                -- 注意：此时是按照改变号进行变化的，不是在当前分支上移动
```

```lua
:earlier/later {count}/{N}s/{N}m/{N}/h/{N}d/{F}f
    -- 转到 {count} 次较早/晚的文本状态。
    -- 转到大约 {N} 秒钟之前的较早/晚的文本状态。
    -- 转到大约 {N} 分钟之前的较早/晚的文本状态。
    -- 转到大约 {N} 小时之前的较早/晚的文本状态。
    -- 转到大约 {N} 天之前的较早/晚的文本状态。
    -- 转到 {N} 次文件写入之前的较早的文本状态。
```


# 撤销的持久性

卸载缓冲区时，Vim 通常会删除该缓冲区建立的撤销树

- 通过设置 'undofile' 选项，Vim 会在写入文件时自动保存撤销历史，而重新编辑文件时，恢复撤销历史
- 撤销文件通常保存在文件本身相同的目录里。这可以用 'undodir' 选项改变


Vim把撤销树保存在一个独立的撤销文件里，每个编辑的文件对应一个

Vim 会检测是否某个撤销文件不再和写它时的那个文件同步 (使用文件内容的哈希值)，如果文件内容在撤销文件写入后有改动，忽略撤销文件，以防止文件遭破坏



```lua
-- 手动保存
:Wundo[!] {file}    -- 把撤销历史写入 {file}
                    -- 如果 {file} 已存在而看起来不像撤销文件 (文件头部的魔术数字不符)，此命令失败。除非加上 !

:rundo {file}       -- 从 {file} 读出撤销历史
```



# 撤销操作的最大次数

能记忆的最大改变次数由 'undolevels' 选项决定
> - 如果它的值是零，我们总是运行在Vi-兼容模式
> - 如果它的值是负的，任何撤销都是不可能的





# 撤销块

单个 undo 命令通常撤掉一个输入的命令，不论这个命令造成多少改变
> 如果键入的命令调用一个函数，那么在这个函数中的所有命令全部被撤销

这个可以撤销的改变序列构成了一个撤销块

```lua
:undoj[oin]     --  把其后的改变和以前的撤销块进行合并

i_<CTRL-G> u    -- 插入模式下让下一改变启用新撤销块
```




# Vi-兼容模式撤销

- Vim模式

多次撤销u可以回到先前的状态

- Vi-兼容模式

一次撤销u'可以用u撤销这次撤销u'，重复撤销请用`.`


取决于option 'cpoptions' 中'u'标志位
