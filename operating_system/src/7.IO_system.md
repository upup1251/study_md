第七章、输入/输出系统

[toc]

输入/输出（input/output，I/O）系统是OS的重要组成部分，用于管理
- 诸如打印机和扫描仪等I/O设备
- 以及用于存储数据的各种存储设备，如磁盘和磁带机等。  
由于设备类型繁多，差异又非常大，I/O系统成为了OS中最繁杂且与硬件最紧密相关的部分。本章将在简要介绍I/O设备的基础上，着重阐述OS对I/O的管理。


![第七章思维导图](assets/2024-11-13-16-18-53.png)


# 1.I/O系统的功能、模型和接口

I/O系统管理的
- 主要对象: I/O设备和相应的设备控制器  
- 主要的任务
    - 满足用户进程提出的I/O请求
    - 提高I/O速度
    - 提高设备的利用率
    - 以及为更高层的进程方便地使用I/O设备提供手段。


## 1.1 I/O系统的基本功能


### 1.1.1 能够隐藏 I/O 设备的细节

I/O设备的类型非常多，且彼此间在很多方面都存在差异
> 如它们接收和产生数据的速度、数据传输方向、数据粒度、数据的表示形式以及可靠性等方面。

为了对这些千差万别的I/O设备进行控制，通常会为它们配置相应的设备控制器。这是一种硬件设备，其中包含若干个用于存放控制命令和参数的寄存器。

用户通过这些命令和参数，可以控制I/O设备执行所要求的操作。显然，对于不同的I/O设备，需要有不同的命令和参数。
> 例如，在对磁盘进行操作时，不仅要给出本次是读命令还是写命令，还要给出源数据或目标数据的位置，包括磁盘的盘面号、磁道号和扇区号。

由此可见，要求程序员或用户编写直接面向这些I/O设备的程序是极其困难的。因此，I/O系统必须通过对I/O设备加以适当的抽象，以隐藏I/O设备的实现细节，仅向上层进程提供少量的、抽象的读/写命令，如read、write等。

### 保证设备无关性


### 提高处理机和I/O设备的利用率



### 能够对I/O设备进行控制

对I/O设备进行控制是设备驱动程序的功能之一

目前对I/O设备有4种控制方式：
- 轮询的可编程I/O方式；
- 中断的可编程I/O方式；
- 直接存储器访问（direct memory access，DMA）方式；
- I/O通道方式。

### 能够确保对设备的正确共享

根据设备的(同一时刻的)共享属性，可将系统中的设备分为两类
- 独占设备
- 共享设备

### 能正确处理错误

<!-- TODO: 还是有点抽象的嘞，到时候再想想 -->


## I/O系统的层次结构与模型

### I/O系统的层次结构

1. 用户层软件: 提供与用户交互的接口，用户可直接调用该层所提供的与I/O操作有关的库函数对设备进行操作。

2. 与设备无关的I/O软件: 实现用户程序与设备驱动程序的统一接口、设备命名、设备保护以及设备的分配与释放等，同时为设备管理和数据传输提供必要的存储空间。

3. 设备驱动程序: 与硬件直接相关，用于执行系统对I/O设备发出的操作指令

4. 中断处理程序: 用于保存被中断进程的CPU现场环境，保存完成后转入相应的中断处理程序处理中断，处理完成后再恢复被中断进程的CPU现场环境，最后返回被中断进程。

![I/O系统的层次结构](assets/2024-11-16-15-19-24.png)

### I/O系统模型


![I/O系统中各种I/O模块之间的层次视图](assets/2024-11-16-15-19-53.png)

1. I/O系统的上/下接口

- I/O系统接口

I/O系统与上层系统之间的接口，向上层系统提供对设备进行操作的抽象I/O命令，以方便上层系统对设备进行使用。有不少OS在用户层提供了与I/O操作有关的库函数供用户使用。

- 软件/硬件接口

上面是中断处理程序和用于不同设备的设备驱动程序。它的下面是各种设备的控制器，

2. I/O系统的分层

与前面所述的I/O软件的分层相对应，I/O系统本身也可分为以下3个层次。


- 中断处理层

    处于I/O系统的最低层，直接与硬件进行交互。
    - 当有I/O设备发来中断请求信号时，在中断硬件做了初步处理后，便转向中断处理程序
    - 它首先保存被中断进程的CPU现场环境，然后转入相应设备的中断处理程序处理中断
    - 在中断处理完成后又恢复被中断进程的CPU现场环境，并返回断点继续运行。

- 设备驱动程序

    它处于I/O系统的次低层，是进程和设备控制器之间的通信程序
    - 功能：将上层发来的抽象I/O请求转换为针对I/O设备的具体命令和参数，并把它们装入设备控制器中的命令寄存器和参数寄存器中，或者相反。
    > 由于设备之间的差异很大，每类设备的驱动程序都不同，故必须由设备制造厂商提供设备驱动程序

- 与设备无关的I/O设备

    基本含义是：I/O软件独立于具体使用的物理设备。
    > 与设备无关的I/O软件的内容包括设备命名、设备分配、数据缓冲和数据高速缓
冲等。


## I/O系统的接口

### 块设备接口

所谓块设备，是指数据的存取和传输都是以数据块为单位的设备。

块设备的特征：
- 传输效率高
- 可寻址





